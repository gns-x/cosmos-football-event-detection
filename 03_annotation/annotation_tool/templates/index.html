<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Video Annotation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr; /* Wider annotation panel for easier access */
            gap: 20px;
            align-items: start; /* Align panels at the top */
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .left-panel, .right-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        /* Keep annotation panel visible while scrolling the video */
        .right-panel {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .panel-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .video-info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .video-info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .info-label {
            font-weight: bold;
            color: #666;
        }

        .info-value {
            color: #333;
        }

        .current-time-display {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Keep video controls accessible and visible */
        .video-controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .scrub-buttons {
            display: flex;
            gap: 6px;
        }
        .kbd {
            background: #eef1ff;
            border: 1px solid #cfd5ff;
            padding: 2px 6px;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            color: #5461d4;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .class-selection {
            margin-bottom: 30px;
        }

        .class-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .class-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s ease;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .class-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .class-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .class-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .class-btn.active {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            border: 3px solid white;
        }

        .annotation-section {
            margin-top: 30px;
        }

        .annotation-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            position: relative;
        }

        .annotation-item .event-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .annotation-item .event-time {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .annotation-item .event-description {
            color: #333;
            font-size: 0.95em;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-info {
            background: #cce5ff;
            color: #004085;
        }

        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .instructions h4 {
            color: #004085;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #004085;
        }

        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öΩ Football Video Annotation Tool</h1>
            <p>Annotate football videos for Cosmos AI training with precision</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="panel-title">üìπ Video Player</div>
                
                <div class="instructions">
                    <h4>üìù How to Annotate:</h4>
                    <ol>
                        <li>Watch the video and identify football events</li>
                        <li>Pause at the event start time</li>
                        <li>Select the event class (e.g., Goal, Penalty, etc.)</li>
                        <li>Click "Add Annotation" to capture current time</li>
                        <li>Click "Save & Next" when finished</li>
                    </ol>
                </div>

                <div class="video-info-card">
                    <h3>üìã Video Information</h3>
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <span class="info-value" id="videoName">Loading...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Class:</span>
                        <span class="info-value" id="videoClass">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Duration:</span>
                        <span class="info-value" id="videoDuration">-</span>
                    </div>
                </div>

                <div class="video-controls-row">
                    <div>
                        <span class="info-label">Current time:</span>
                        <span class="current-time-display" id="currentTime" style="display:inline-block; padding:6px 10px; font-size:1.2em; background:#eef1ff; color:#333; border-radius:8px;">0:00</span>
                    </div>
                    <div class="scrub-buttons">
                        <button class="btn" style="padding:8px 12px;" onclick="seekRelative(-5)">‚è™ -5s <span class="kbd">J</span></button>
                        <button class="btn" style="padding:8px 12px;" onclick="togglePlayPause()">‚èØÔ∏è Play/Pause <span class="kbd">Space</span></button>
                        <button class="btn" style="padding:8px 12px;" onclick="seekRelative(5)">+5s ‚è© <span class="kbd">L</span></button>
                    </div>
                </div>

                <div class="video-container">
                    <video id="videoPlayer" controls>
                        Your browser does not support the video tag.
                    </video>
                </div>

                <div class="progress-section">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: bold;">Overall Progress</span>
                        <span id="progressText">0 / 0 videos</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progressBar" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="panel-title">üéØ Annotation Panel</div>

                <div class="class-selection">
                    <h3 style="margin-bottom: 15px; color: #333;">Select Event Class:</h3>
                    <div class="class-buttons" id="classButtons"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addAnnotation()" title="Keyboard: A">
                        ‚ûï Add Annotation <span class="kbd">A</span>
                    </button>
                </div>

                <div class="annotation-section">
                    <h3 style="margin-bottom: 15px; color: #333;">üìù Current Annotations:</h3>
                    <div id="annotations"></div>
                </div>

                <div class="action-buttons" style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="saveAndNext()" title="Keyboard: S">
                        üíæ Save & Next <span class="kbd">S</span>
                    </button>
                    <button class="btn btn-danger" onclick="skipVideo()" title="Keyboard: N">
                        ‚è≠Ô∏è Skip <span class="kbd">N</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentVideo = 0;
        let videos = [];
        let annotations = [];
        let selectedClass = null;
        let eventClasses = [];

        async function initializeTool() {
            try {
                document.getElementById('videoName').textContent = 'Loading...';
                
                // Load event classes
                const classesResponse = await fetch('/api/event-classes');
                eventClasses = await classesResponse.json();
                createClassButtons();
                
                // Load videos
                await loadVideoList();
                
                // Update progress
                updateProgress();
                
                // Update current time display every 100ms
                const videoPlayer = document.getElementById('videoPlayer');
                setInterval(() => {
                    const current = videoPlayer.currentTime;
                    document.getElementById('currentTime').textContent = formatTime(current);
                }, 100);
                
                // Keyboard shortcuts for faster UX
                document.addEventListener('keydown', (e) => {
                    // Ignore when typing in inputs (not used now, but future-safe)
                    const tag = (e.target || {}).tagName || '';
                    if (['INPUT','TEXTAREA'].includes(tag)) return;
                    
                    if (e.code === 'Space') { e.preventDefault(); togglePlayPause(); }
                    if (e.key.toLowerCase() === 'a') { e.preventDefault(); addAnnotation(); }
                    if (e.key.toLowerCase() === 's') { e.preventDefault(); saveAndNext(); }
                    if (e.key.toLowerCase() === 'n') { e.preventDefault(); skipVideo(); }
                    if (e.key.toLowerCase() === 'j') { e.preventDefault(); seekRelative(-5); }
                    if (e.key.toLowerCase() === 'l') { e.preventDefault(); seekRelative(5); }
                });
                
                // Update duration when video loads
                videoPlayer.addEventListener('loadedmetadata', () => {
                    document.getElementById('videoDuration').textContent = formatTime(videoPlayer.duration);
                });
                
            } catch (error) {
                console.error('Error initializing tool:', error);
                alert('Error loading tool. Please check console for details.');
            }
        }

        function createClassButtons() {
            const container = document.getElementById('classButtons');
            container.innerHTML = '';
            
            const colors = [
                '#e74c3c', // penalty_shot - red
                '#3498db', // goal - blue
                '#2ecc71', // goal_line_event - green
                '#f39c12', // woodworks - orange
                '#9b59b6', // shot_on_target - purple
                '#1abc9c', // red_card - teal
                '#34495e', // yellow_card - dark gray
                '#e67e22'  // hat_trick - dark orange
            ];
            
            eventClasses.forEach((cls, idx) => {
                const btn = document.createElement('button');
                btn.className = 'class-btn';
                btn.style.backgroundColor = colors[idx];
                btn.textContent = cls.replace(/_/g, ' ').toUpperCase();
                btn.onclick = () => selectClass(cls, btn);
                container.appendChild(btn);
            });
        }

        async function loadVideoList() {
            try {
                const response = await fetch('/api/videos');
                videos = await response.json();
                
                if (videos.length > 0) {
                    loadCurrentVideo();
                } else {
                    alert('‚ùå No videos found! Please ensure videos are downloaded in 01_data_collection/raw_videos/');
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                alert('‚ùå Error loading videos. Check console for details.');
            }
        }

        function loadCurrentVideo() {
            if (currentVideo < videos.length) {
                const video = videos[currentVideo];
                const videoPlayer = document.getElementById('videoPlayer');
                
                // Update UI
                document.getElementById('videoName').textContent = video.name;
                document.getElementById('videoClass').textContent = video.class.replace(/_/g, ' ');
                document.getElementById('currentTime').textContent = '0:00';
                
                // Load video using pre-encoded url_path if provided
                const apiPath = video.url_path ? video.url_path : video.path;
                videoPlayer.src = `/api/video/${apiPath}`;
                
                // Reset annotations
                annotations = [];
                updateAnnotationsList();
                
                // Deselect class
                selectedClass = null;
                document.querySelectorAll('.class-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                updateProgress();
            } else {
                alert('üéâ All videos processed! Great job!');
            }
        }

        function selectClass(classId, button) {
            // Remove active class from all buttons
            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected button
            button.classList.add('active');
            selectedClass = classId;
            
            console.log('Selected class:', classId);
        }

        function addAnnotation() {
            if (!selectedClass) {
                alert('‚ö†Ô∏è Please select an event class first!');
                return;
            }
            
            const videoPlayer = document.getElementById('videoPlayer');
            const currentTime = videoPlayer.currentTime;
            
            const annotation = {
                description: `${selectedClass.replace(/_/g, ' ').toUpperCase()} event detected`,
                start_time: formatTime(currentTime),
                end_time: formatTime(Math.min(currentTime + 5, videoPlayer.duration)),
                event: selectedClass
            };
            
            annotations.push(annotation);
            updateAnnotationsList();
            
            console.log('Annotation added:', annotation);
        }

        function updateAnnotationsList() {
            const container = document.getElementById('annotations');
            
            if (annotations.length === 0) {
                container.innerHTML = '<div class="empty-state">No annotations yet. Click "Add Annotation" to start.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            annotations.forEach((ann, idx) => {
                const div = document.createElement('div');
                div.className = 'annotation-item';
                div.innerHTML = `
                    <div class="event-name">${ann.event.replace(/_/g, ' ').toUpperCase()}</div>
                    <div class="event-time">‚è±Ô∏è Time: ${ann.start_time} - ${ann.end_time}</div>
                    <div class="event-description">${ann.description}</div>
                    <button class="delete-btn" onclick="removeAnnotation(${idx})">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }

        function removeAnnotation(index) {
            if (confirm('Delete this annotation?')) {
                annotations.splice(index, 1);
                updateAnnotationsList();
            }
        }

        function togglePlayPause() {
            const v = document.getElementById('videoPlayer');
            if (v.paused) { v.play(); } else { v.pause(); }
        }

        function seekRelative(delta) {
            const v = document.getElementById('videoPlayer');
            v.currentTime = Math.max(0, Math.min(v.duration || 0, v.currentTime + delta));
        }

        async function saveAndNext() {
            if (annotations.length === 0) {
                if (!confirm('No annotations for this video. Skip it?')) {
                    return;
                }
                skipVideo();
                return;
            }
            
            // Save annotations
            await saveCurrentAnnotations();
            
            // Move to next video
            currentVideo++;
            annotations = [];
            loadCurrentVideo();
        }

        function skipVideo() {
            if (confirm('Skip this video without saving?')) {
                currentVideo++;
                annotations = [];
                loadCurrentVideo();
            }
        }

        async function saveCurrentAnnotations() {
            if (annotations.length === 0) return;
            
            const video = videos[currentVideo];
            
            try {
                const response = await fetch('/api/annotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        video: video.name,
                        event_class: video.class,
                        annotations: annotations
                    })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Annotations saved successfully');
                    updateProgress();
                } else {
                    alert('‚ùå Failed to save annotations. Please try again.');
                }
            } catch (error) {
                console.error('Error saving:', error);
                alert('‚ùå Error saving annotations. Check console for details.');
            }
        }

        async function updateProgress() {
            try {
                const response = await fetch('/api/progress');
                const data = await response.json();
                
                const progressPercent = data.progress || 0;
                document.getElementById('progressBar').style.width = progressPercent + '%';
                document.getElementById('progressBar').textContent = Math.round(progressPercent) + '%';
                document.getElementById('progressText').textContent = `${data.annotated} / ${data.total} videos`;
                
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeTool);
    </script>
</body>
</html>
